<script type='text/javascript'>
   var map, infobox;

   function GetMap() {
      var val = '{{centre_latitude}}'
      var lat = val.replace(",", ".");
      var val = '{{centre_longitude}}'
      var lon = val.replace(",", ".");

       map = new Microsoft.Maps.Map('#myMap', {
         center: new Microsoft.Maps.Location(parseFloat(lat), parseFloat(lon))
       });
  
       //Create an infobox at the center of the map but don't show it.
       infobox = new Microsoft.Maps.Infobox(map.getCenter(), {
           visible: false
       });

       //Assign the infobox to a map instance.
       infobox.setMap(map);


       
       {% for market in listMarket %}
       var val = '{{market.latitude}}'
       var lat = val.replace(",", ".");
       var val = '{{market.longitude}}'
       var lon = val.replace(",", ".");
       locs= new Microsoft.Maps.Location(parseFloat(lat), parseFloat(lon));
       var pin  = new Microsoft.Maps.Pushpin(locs);
 
     pin.metadata = {
            title: '{{market.nom}}',
            description: '{{market.adresse}} {{market.cp}}  {{market.ville}}'
          };

           //Add a click event handler to the pushpin.
           Microsoft.Maps.Events.addHandler(pin, 'click', pushpinClicked);

           //Add pushpin to the map.
           map.entities.push(pin);
      {% endfor %}
   }
   
   function pushpinClicked(e) {
      //Make sure the infobox has metadata to display.
      if (e.target.metadata) {
          //Set the infobox options with the metadata of the pushpin.
          infobox.setOptions({
              location: e.target.getLocation(),
              title: e.target.metadata.title,
              description: e.target.metadata.description,
              visible: true
          });
      }
  }

   </script>
   <script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?callback=GetMap&key=Aj-CW4KKZ2QbFVCuOEKVg7PpUsZvMYhJaKLY226BDjRkw-s4tJCKsv0onicoVP5d' async defer></script>

   <div id="myMap" style="position:relative;width:800px;height:600px;"></div>